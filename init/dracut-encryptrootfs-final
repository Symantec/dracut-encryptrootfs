#!/usr/bin/env bash
file_marker=/etc/encryptrootfs-initramfs

. /etc/dracut.conf.d/encryptrootfs.conf

_check_errors(){
   if [[ $? -gt 0 ]]
   then
        _warning "Error during $1. Returned code is not 0 but '$?'"
        exit 1
   fi
}

if [ -a $file_marker ]
then
    echo "File-marker $file_marker found. Performing final modifications."
    set -x

    [[ -z "${boot_partition_label}" ]] && boot_partition_label="boot"
    [[ -z "${boot_partition_file_system}" ]] && boot_partition_file_system="ext3"

    mv /boot/ /boot_
    mkdir /boot
    if [[ -z $(grep "/boot" "/etc/fstab") ]] ; then
        echo "LABEL=${boot_partition_label}    /boot  ${boot_partition_file_system}    defaults        1 1" >> /etc/fstab
    fi

    mount -a
    _check_errors "mounting boot device"
    cp -a /boot_/* /boot/
    rm -rf /boot_/

    boot_opts=""

    #TODO(illia) minimize GRUB config changes
    #networking
    boot_opts=$boot_opts" rd.neednet=1 ip=dhcp rd.net.dhcp.retry=5 rd.net.timeout.dhcp=60"

    #debug brakepoint
    #boot_opts=$boot_opts" rd.break=pre-mount"

    #debug options
    boot_opts=$boot_opts" rd.shell rd.debug log_buf_len=1M"

    cat > /etc/default/grub << EOM
GRUB_TIMEOUT=5
GRUB_DISTRIBUTOR="\$(sed 's, release .*\$,,g' /etc/system-release)"
GRUB_DEFAULT=saved
GRUB_DISABLE_SUBMENU=true
GRUB_TERMINAL_OUTPUT="console"
GRUB_CMDLINE_LINUX="ttyS0,115200n8 console=tty0 vconsole.font=latarcyrheb-sun16 vconsole.keymap=us biosdevname=0 plymouth.enable=0 crashkernel=auto ${boot_opts}"
GRUB_DISABLE_RECOVERY="false"
GRUB_DISABLE_LINUX_UUID="true"
GRUB_DEVICE="/dev/sda1"
EOM

    #grub manipulation are here
    grub2-mkconfig -o /boot/grub2/grub.cfg
    _check_errors "generating new grub config"
    grub2-install ${disk}
    _check_errors "installing grub to ${disk}"

    #removing generated by anaconda mount of '/'
    sed -i '/ \/ /d' /etc/fstab
    _check_errors "Removing '/' mount point"

    rm -rf $file_marker
    _check_errors "removing file-marker $file_marker"
    set +x
else
    echo "No file-marker  '$file_marker' found. Assuming that all final actions were performed previously."
fi